name: ğŸš€ X-Fleet CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 600s
          script: |
            set -e
            
            echo "ğŸš€ Starting X-Fleet deployment..."
            
            # Navigate to application directory
            cd /home/ubuntu/x-fleet
            
            # Pull latest changes from GitHub
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            if [ -d ".git" ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              echo "âŒ Not a git repository. Skipping git pull."
            fi
            
            # Install/Update dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci
            
            # Generate Prisma clients
            echo "ğŸ”§ Generating Prisma clients..."
            npx prisma generate --schema=prisma/primary.prisma
            npx prisma generate --schema=prisma/logs.prisma
            npx prisma generate --schema=prisma/address.prisma
            
            # Run database migrations
            echo "ğŸ—„ï¸ Running database migrations..."
            npx prisma migrate deploy --schema=prisma/primary.prisma
            npx prisma migrate deploy --schema=prisma/logs.prisma
            npx prisma migrate deploy --schema=prisma/address.prisma
            
            # Build the application
            echo "ğŸ”¨ Building application..."
            npm run build
            
            # Restart PM2 application
            echo "ğŸ”„ Restarting application with PM2..."
            pm2 restart ecosystem.config.js --update-env
            
            # Save PM2 configuration
            pm2 save
            
            # Show PM2 status
            echo "âœ… Deployment completed! Current PM2 status:"
            pm2 status
            
            echo "ğŸ‰ X-Fleet deployed successfully!"

      - name: ğŸ§ª Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            echo "ğŸ¥ Running health check..."
            
            # Wait for application to start
            sleep 10
            
            # Check if application is responding
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001 || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… Health check passed! Application is running."
              echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
              exit 0
            else
              echo "âŒ Health check failed! HTTP status: $RESPONSE"
              echo "ğŸ“‹ PM2 logs:"
              pm2 logs --nostream --lines 50
              exit 1
            fi

      - name: ğŸ“¢ Deployment Status
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… Deployment succeeded!"
            echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
